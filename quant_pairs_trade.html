<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pairs Trading</title>



    <link rel="stylesheet" href="css/metacognition_.css">


    <!-- icon -->
    <link rel="shortcut icon" type="image/jpg" href="images/favicon.PNG" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


    <!-- bootstrap css -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
    <!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration -->
    

</head>

<body>

    <div class="flexbox">
        <!-- navbar -->
        <div id="mySidenav" class="sidebar-nav flexbox-item-1">

            <div class="contentblock">

                <div class="sidebar-nav-item" id="blogtitle">Ryan's Blog</div>
                <!-- <div class="sidebar-nav-item" id="caption">A Journey of Learning</div> -->
                <img class="sidebar-nav-item" id="logo" src="images/R.png" height=90>


                <div class="sidebaritems">
                    <a class="sidebar-nav-item active" href="index.html">Home<i class="fa fa-home" aria-hidden="true" id="homelogo"></i></a>
                    <a class="sidebar-nav-item" href="https://github.com/ryanczm/Quant" target="_blank"> Github <i class="fa fa-github" style="font-size:24px"></i></a>
                    <a class="sidebar-nav-item" href="post_archive.html">Post Archive</a>
                    <a class="sidebar-nav-item" href="about.html">About</a>
                    <!-- <a class="sidebar-nav-item" href="metacognition.html" target="_blank"> Thinking about Thinking <i class="fa fa-star" style="font-size:24px"></i></a> -->
                    <!-- <p class="sidebar-nav-item" id="credits">Â© Ryan Chew 2020. Website In Progress</p> -->
                </div>
            </div>
        </div>

        <main class="flexbox-item-2">
            <nav class="section-nav">
                <p><i>Table of Contents</i></p>
                <ol>
                    <li><a href="#Strategy Overview">Strategy Overview</a></li>
                    <li><a href="#Selection & Trading Phase">Selection & Trading Phase</a></li>
                    <li><a href="#Performance Analysis">Performance Analysis</a></li>
                    <li><a href="#Cointegration, Returns & Sector Analysis">Cointegration, Returns & Sector Analysis</a></li>
                    <li><a href="#Conclusion">Conclusion</a></li>
                </ol>

            </nav>

            <h1>A First Foray into Quant Analysis: An Elementary Pairs Trading Strategy </h1>
            <div class="post-metadata">
                <span style="display: inline" class="post-date">23 March 2023 &middot;  15 min read</span> &emsp;
                <span style="display:inline">[ Quantitative Finance ]</span>
            </div>

            <section id="Strategy Overview">
                <h2>Strategy Overview</h2>
         
                    <p>In this post I implement a simple pairs trading strategy based on bivariate cointegration tests in the selection phase on NASDAQ 100 equities. The selection phase will be based on data from 2018-2021. The trading & evaluation phase will be from 2021-2023. The repo is <a href="https://github.com/ryanczm/qr/blob/master/pairs_trading_nasdaq.ipynb"> <i class="fa fa-github"></i> here</a>. </p>
                    <p>I am aware of the many gaps and things not done (e.g proper screening, more creative alpha/strat, etc), but this is a basic project for learning. This project exposed me to the concepts of survivorship bias and p-hacking/data dredging.</p>
            </section>

            <section id="Selection & Trading Phase">
                <h2>Selection & Trading Phase</h2>
                    
                <h3>Universe & Cointegration Tests</h3>
                    <p>The data used was daily data from yfinance. I didnâ€™t adjust for corporate actions. I then select pairs based off the bivariate Engle-Granger cointegration test on the in-sample period. This regresses one series against the other to get the beta coefficient, creates the spread/residual series off it, then performs a unit root test to check for stationarity.</p>
                    <img src="images/quant_pairs_trade/1_code_cointegration.png", height="400", class="center">
                    <p>This lets us select pairs which are cointegrated for the in-sample period (2018 to Jan 2021). However, more pairs and tests exposes us to <i><a href="https://www.quantrocket.com/codeload/quant-finance-lectures/quant_finance_lectures/Lecture23-p-Hacking-and-Multiple-Comparisons-Bias.ipynb.html">multiple comparison bias</a></i>, which
                    invalides the interpretation of p-values as the number of tests increase.</p>
                    <img src="images/quant_pairs_trade/cointegration_heatmap.png", height="950", class="center">
                <h3>Trading Phase</h3>
                    <p>Once pairs are selected, we compute a spread for each pair. Then, we smooth it out, and set entry/exit thresholds. The spread is computed off a dynamic hedge ratio, evolved in online, recursive fashion via a Kalman filter (which turns out to be surprisingly effective at keeping a spread stationary even if the underlying assets are not as cointegrated!) </p>
                    <img src="images/quant_pairs_trade/2_code_kalman.png", height="430", class="center">
                    <p>The spread is then z-scored via two rolling windows. The shorter average of the past $z_s$ days is demeaned by a longer average of the past $z_l$ days, then divided by the standard deviation of $z_l$.  We enter positions when this spread is above $[z,-z]$ and exit when it crosses 0. If it crosses the top, long the bottom asset and short the top asset to form the top leg, and vice versa. The parameters are thus the short (5D) and long (30D) windows and the thresholds (0.5 and -0.5). </p>
                    <img src="images/quant_pairs_trade/3_code_simulate_trades.png", height="700", class="center">
                <h3>Single Pair Demonstration</h3>
                    <p>To illustrate, I chose an arbitrary same-sector from the backtest, INTC vs QCOM, with out-sample Sharpe of 1.467 (75th percentile) and a I.R of 0.78 (75th percentile).</p>
                    <p>Here is the price chart for the pair:</p>
                    <img src="images/quant_pairs_trade/intl_qcom_prices.png", height="400", width="900" class="center">
                    <p>The z-scored spread defines the entry and exit times:</p>
                    <img src="images/quant_pairs_trade/intl_qcom_z.png", height="400", width="900" class="center">
                    <p>Which is then reflected on the actual spread itself:</p>
                    <img src="images/quant_pairs_trade/intl_qcom_spread.png", height="400", width="900" class="center">
                    <p>Which we can track positions taken.</p>
                    <img src="images/quant_pairs_trade/trades.png", height="400" class="center">
                    <p>We can run this simulation for all pairs in a chosen set and get the cumulative value/return for the out-of-sample period to analyze. I separated into in-sample/out-sample and same-sector/all pairs. The idea is to only screen for same-sector pairs based on a higher likelihood of some economic relationship. We'll investigate this later. In total, we have ~4000 possible pairs, but ~400 cointegrated ones according to the test statistic and 90 of those from the same-sector.</p>
            </section>
    
            <section id="Performance Analysis">
                <h2>Performance</h2>
                    <p>Before analyzing the relationship between sectors, cointegration and returns more closely, I first examine the out-of-sample performance (start 2021 to 2023 Feb) of selected sets of pairs.</p>
                    <img src="images/quant_pairs_trade/4_code_test_sharpe.png", height="385", class="center">
                <h3>Sharpe Ratio Caveats</h3>
                    <p>One problem I had with calculation of returns and Sharpe was the initial capital for a pair. If we start from 0 initial capital, the first few months tends to give very volatile returns. Returns for the first few round trip trades tend to be disproportionate, despite portfolio value changing very little, as seen by the equity curve. This increases volatility and compresses the Sharpe ratio calculation.</p>
                    <img src="images/quant_pairs_trade/intl_qcom_equity_curve.png", height="355", class="center">
                    <p>I decided to smooth it out by starting with initial capital equal to the hedge ratio times the stock price at the start of the period. Iâ€™m not sure if this is corrrect. </p>
                    <img src="images/quant_pairs_trade/intl_qcom_normrets.png", height="355", class="center">
                <h3>Sector vs No Sector Restriction Performance</h3>
                    <p>I then iterated through all selected pairs with a p-value less than the arbitary cutoff of 0.10: ~430 pairs with no sector restriction and ~96 pairs with sector restriction.</p>
                    <img src="images/quant_pairs_trade/sharpe.png", height="400", class="center">
                    <p>The average mean and median annualized Sharpe for both sets of pairs was roughly the same ~0.60, and ~0.82. However, from the histogram, it is evident the no-sector restriction pairs has an extreme left tail of poor performers while the same-sector pairs had a floor on bad performance. This would support the hypothesis that cointegrated same-sector pairs are less likely to perform poorly out-sample because they have a higher likelihood of some underlying economic relationship. </p>
                    <img src="images/quant_pairs_trade/ir.png", height="400", class="center">
                    <p>IR was decent with a median of ~0.35 and a mean of ~0.45, beating the benchmark. However, I am not sure if IR is relevant here because pairs trading is market neutral anyway. We can then plot cumulative (mean) returns against the benchmark:</p>
                    <img src="images/quant_pairs_trade/cumrets_is.png", height="400", class="center"> 
                    <img src="images/quant_pairs_trade/cumrets_oos.png", height="400", class="center">
                    <p>If anything, I guess this is graphical representation of what a market-neutral strategy is.</p>
            </section>

          
            <section id="Cointegration, Returns & Sector Analysis">
                <h2>Cointegration, Returns & Sector Analysis</h2>
                    <p><i>Does same sector mean more likely to be cointegrated?</i> This analysis assumes p-values are a measure of strength of effect, i.e the lower the p-value, the more significant an effect. I do not have enough knowledge in statistics to comment on this, so I just take it for granted. We can look in-sample at the empirical distributions of p-values for all pairs vs same-sector pairs:</p>
                    <img src="images/quant_pairs_trade/pval_comparison.png", height="400", class="center">
                    <p>Unfortunately, the difference seems to be very marginal. The KDE plots show only very minor differences. Which means that the proportion of cointegration is roughly the same! </p>
                    <!-- <p>We can also analyze, in-sample, how cointegration trends differ across sectors. The number of pairs per sector is disproportionate, since NDX is heavily comprised of technology stocks. However, it seems industrials and consumer staples have a greater proportion of cointegrated stocks.</p>
                    <img src="images/quant_pairs_trade/pval_sector.png", height="300", class="center"> -->
                <h3>Cointegration and Sharpe</h3>
                    <p><i>How well does cointegration imply Sharpe?</i> Ideally, we would run the strategy for all pairs (~4000), calculate their in-sample Sharpes, then compute the Spearman rank or Pearson correlation coefficient with p-values. Due to computation, I did this for the top and bottom deciles of p-value (<0.10 and >0.80) as a form of pseudo-quantile analysis.</p>
                        <img src="images/quant_pairs_trade/pval_vs_sharpe.png", height="500", class="center">
                    <p>I would have expected a stronger correlation. However (not shown here) I think the high Sharpe ratios of non-cointegrated pairs seem to be due to the power of the Kalman filter and my very simplistic backtest. When I plotted spreads of least cointegrated pairs, they all looked quite stationary, so I am attributing this to the Kalman filter.</p>
                <h3>Cointegration Out-of-Sample </h3>
                    <p>To what extent does in-sample cointegration imply out-sample cointegration? Unfortunately, there is little to no relationship as demonstrated by the scatterplot:</p>
                    <img src="images/quant_pairs_trade/pval_is_vs_oos.png", height="500", class="center">
                    <p>There is no correlation, sadly, which does invalidate this whole project, since we are just trading random pairs that have no guarantee of being cointegrated. I suppose a better idea would be to try to predict future cointegration for a certain lookahead window (e.g features to predict the target which is a cointegration p-value) then trade pairs.</p>
            </section>

            <section id="Conclusion">
                <h2>Conclusion</h2>
                    <!-- <p>Another approach would be to shrink the in-sample/out-sample windows, e.g quarterly, then rebalancing your pairs every quarter. This would ensure 'decay' for cointegration is improved, if you are continuously testing every few months. However, this would not solve the main problem:</p> -->
                    <p>So unfortunately, it does seem that <i>in-sample cointegration is a very poor predictor of out-sample cointegration</i>, as seen by the scatter which looks like literally a 2D uniform random vector. It didn't even have the courtesy to look like white noise ðŸ˜  (e.g 2D Gaussian)! </p>
                              
                    <p>This project has let me get basic exposure to quant trading and practicing what I have learned, it is amateurish but the main objective is to keep learning and improving consistently.</p>

                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                </section>
                    </main>
    </div>


    <script src="js/fundamental_analysis.js"></script>

</body>

</html>